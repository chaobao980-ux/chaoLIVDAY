<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æ¼¢å ¡å¤§è½‰ç›¤æŠ½ç</title>
  <style>
    body {
      background: #e6f7e6;
      font-family: "Microsoft JhengHei", sans-serif;
      text-align: center;
      color: #2e7d32;
    }
    h1 {
      margin-top: 20px;
      color: #1b5e20;
    }
    .container {
      position: relative;
      margin: 20px auto;
      width: 400px;
      height: 400px;
    }
    #wheel {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 8px solid #388e3c;
      transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
    }
    #pointer {
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 25px solid transparent;
      border-right: 25px solid transparent;
      border-bottom: 50px solid #e53935;
      z-index: 10;
    }
    button {
      margin: 10px;
      padding: 12px 30px;
      font-size: 18px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover {
      background: #388e3c;
    }
    #result {
      margin-top: 20px;
      font-size: 22px;
      font-weight: bold;
      color: #1b5e20;
    }
    #remaining {
      margin-top: 10px;
      font-size: 18px;
      color: #33691e;
      font-weight: bold;
    }
    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 90%;
      max-width: 600px;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 10px;
      border: 1px solid #c8e6c9;
      text-align: center;
    }
    th {
      background-color: #81c784;
      color: #fff;
      font-size: 16px;
    }
    td {
      font-size: 15px;
      color: #2e7d32;
    }
    input.qtyInput {
      width: 60px;
      padding: 4px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>ğŸ” æ¼¢å ¡å¤§è½‰ç›¤æŠ½ç ğŸŸ</h1>
  <div class="container">
    <div id="pointer"></div>
    <canvas id="wheel"></canvas>
  </div>
  <button onclick="spin()">æŠ½ç</button>
  <button onclick="resetPrizes()">é‡è£½çé …</button>
  <p id="result"></p>
  <p id="remaining"></p>

  <!-- çå“è¡¨æ ¼ -->
  <table id="prizeTable">
    <thead>
      <tr>
        <th>çå“åç¨±</th>
        <th>å‰©é¤˜æ•¸é‡</th>
        <th>ä¿®æ”¹æ•¸é‡</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // åˆå§‹çå“æ•¸é‡
    const initialPrizes = [
      {name: "æ¼¢å ¡æŠ±æ•", qty: 20},
      {name: "æ¼¢å ¡é‘°åŒ™åœˆ", qty: 80},
      {name: "æ¼¢å ¡é£²æ–™å…Œæ›åˆ¸", qty: 64},
      {name: "35å…ƒé£²æ–™å…Œæ›åˆ¸", qty: 136},
      {name: "å¥—é¤50å…ƒæŠ˜æŠµåˆ¸", qty: 100},
      {name: "è–¯æ¢å…Œæ›åˆ¸", qty: 100},
      {name: "95æŠ˜åˆ¸(QRä¸‹è¼‰å‡ºç¤º)", qty: 500},
      {name: "10å…ƒæŠ˜åƒ¹åˆ¸", qty: 1000}
    ];
    let prizes = JSON.parse(JSON.stringify(initialPrizes));

    let canvas = document.getElementById("wheel");
    let ctx = canvas.getContext("2d");
    let size = 400;
    canvas.width = size;
    canvas.height = size;

    let colors = ["#a5d6a7","#81c784","#66bb6a","#4caf50",
                  "#388e3c","#66bb6a","#81c784","#a5d6a7"];

    let spinning = false;

    function drawWheel() {
      ctx.clearRect(0, 0, size, size);
      let num = prizes.length;
      let arc = 2 * Math.PI / num;
      for (let i = 0; i < num; i++) {
        ctx.beginPath();
        ctx.fillStyle = colors[i % colors.length];
        ctx.moveTo(size/2, size/2);
        ctx.arc(size/2, size/2, size/2-5, i*arc, (i+1)*arc);
        ctx.fill();
        ctx.save();
        ctx.translate(size/2, size/2);
        ctx.rotate(i*arc + arc/2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#1b5e20";
        ctx.font = "15px Microsoft JhengHei";
        ctx.fillText(prizes[i].name, size/2 - 20, 5);
        ctx.restore();
      }
    }

    function updateTable() {
      let tbody = document.querySelector("#prizeTable tbody");
      tbody.innerHTML = "";
      prizes.forEach((p, i) => {
        let row = `
          <tr>
            <td>${p.name}</td>
            <td>${p.qty}</td>
            <td><input class="qtyInput" type="number" min="0" value="${p.qty}" onchange="changeQty(${i}, this.value)"></td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
      let total = prizes.reduce((sum, p) => sum + p.qty, 0);
      document.getElementById("remaining").innerText = "å‰©é¤˜çé …ç¸½æ•¸ï¼š" + total;
    }

    function changeQty(index, value) {
      prizes[index].qty = parseInt(value) || 0;
      drawWheel();
      updateTable();
    }

    function resetPrizes() {
      prizes = JSON.parse(JSON.stringify(initialPrizes));
      drawWheel();
      updateTable();
      document.getElementById("result").innerText = "âœ… å·²é‡è£½çé …æ•¸é‡";
    }

    function spin() {
      if (spinning) return;
      let available = prizes.filter(p => p.qty > 0);
      if (available.length === 0) {
        document.getElementById("result").innerText = "ğŸ‰ æ‰€æœ‰çå“æŠ½å®Œï¼";
        return;
      }

      // éš¨æ©ŸæŒ‘é¸çå“
      let totalQty = available.reduce((sum, p) => sum + p.qty, 0);
      let rand = Math.floor(Math.random() * totalQty);
      let cumulative = 0;
      let selectedIndex;
      for (let i = 0; i < available.length; i++) {
        cumulative += available[i].qty;
        if (rand < cumulative) {
          selectedIndex = prizes.indexOf(available[i]);
          break;
        }
      }

      let num = prizes.length;
      let arc = 360 / num;
      let extraSpins = Math.floor(Math.random() * 6) + 3; // éš¨æ©Ÿ 3~8 åœˆ
      let stopAngle = (360 - (selectedIndex * arc + arc/2)) + (360 * extraSpins);

      spinning = true;

      // å…ˆæ¸…æ‰å‹•ç•«è¨­å®š
      canvas.style.transition = "none";
      canvas.style.transform = `rotate(0deg)`;

      // è§¸ç™¼é‡ç¹ª
      void canvas.offsetWidth;

      // è¨­å®šæ–°çš„å‹•ç•«
      canvas.style.transition = "transform 5s cubic-bezier(0.25, 0.1, 0.25, 1)";
      canvas.style.transform = `rotate(${stopAngle}deg)`;

      setTimeout(() => {
        prizes[selectedIndex].qty--;
        document.getElementById("result").innerText = "ğŸ æ­å–œæŠ½ä¸­ï¼š" + prizes[selectedIndex].name;
        spinning = false;
        drawWheel();
        updateTable();
      }, 5200);
    }

    // åˆå§‹åŒ–
    drawWheel();
    updateTable();
  </script>
</body>
</html>
